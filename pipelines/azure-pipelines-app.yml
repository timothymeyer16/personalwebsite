# =============================================================================
# Azure DevOps Pipeline - Application Build and Deploy
# =============================================================================
# GitOps Workflow:
#   1. Create feature branch, make changes to src/**
#   2. Push branch ‚Üí PR to main
#   3. Pipeline runs: Build + Test (PR validation)
#   4. Review build results, approve PR
#   5. Merge to main ‚Üí Deploy to Azure App Service
# =============================================================================

# Only trigger deploy on main branch (after PR merge)
trigger:
  branches:
    include:
      - main
  paths:
    include:
      - src/**

# Run build validation on PRs targeting main
pr:
  branches:
    include:
      - main
  paths:
    include:
      - src/**

variables:
  buildConfiguration: 'Release'
  dotnetVersion: '7.x'
  nodeVersion: '20.x'
  azureSubscription: 'Azure-ServiceConnection' # Update with your service connection name
  appServiceName: 'app-personalwebsite-prod'
  resourceGroupName: 'rg-personalwebsite-prod'

stages:
  # Build Stage
  - stage: Build
    displayName: 'Build'
    jobs:
      - job: BuildJob
        displayName: 'Build React & .NET'
        pool:
          vmImage: 'windows-latest'
        
        steps:
          # Checkout code
          - checkout: self
            fetchDepth: 1

          # Setup Node.js
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: '$(nodeVersion)'

          # Setup .NET
          - task: UseDotNet@2
            displayName: 'Install .NET SDK'
            inputs:
              version: '$(dotnetVersion)'

          # Build React Frontend
          - template: templates/build-web.yml
            parameters:
              workingDirectory: 'src/PersonalWebsite.Web'

          # Build .NET API
          - template: templates/build-api.yml
            parameters:
              workingDirectory: 'src/PersonalWebsite.Api'
              buildConfiguration: '$(buildConfiguration)'

          # Copy React build to API wwwroot
          - task: CopyFiles@2
            displayName: 'Copy React build to API wwwroot'
            inputs:
              sourceFolder: 'src/PersonalWebsite.Web/dist'
              contents: '**'
              targetFolder: 'src/PersonalWebsite.Api/bin/$(buildConfiguration)/net7.0/publish/wwwroot'

          # Publish artifact
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Artifact'
            inputs:
              pathToPublish: 'src/PersonalWebsite.Api/bin/$(buildConfiguration)/net7.0/publish'
              artifactName: 'webapp'

  # ==========================================================================
  # Deploy Stage (Only runs on main branch after PR merge)
  # ==========================================================================
  - stage: Deploy
    displayName: 'üöÄ Deploy to Production'
    dependsOn: Build
    # Only run Deploy stage when:
    # 1. Build succeeded AND
    # 2. This is the main branch AND
    # 3. Not a PR validation build
    condition: |
      and(
        succeeded(),
        eq(variables['Build.SourceBranch'], 'refs/heads/main'),
        ne(variables['Build.Reason'], 'PullRequest')
      )
    jobs:
      - deployment: DeployJob
        displayName: 'üöÄ Deploy to Azure App Service'
        pool:
          vmImage: 'windows-latest'
        # ‚ö†Ô∏è This environment must have approval configured in Azure DevOps
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - template: templates/deploy-app-service.yml
                  parameters:
                    azureSubscription: '$(azureSubscription)'
                    appServiceName: '$(appServiceName)'
                    resourceGroupName: '$(resourceGroupName)'
