# Azure DevOps Pipeline - Database Migrations
# Applies EF Core migrations to Azure SQL Database

trigger: none  # Manual trigger only

pr: none  # No PR trigger

parameters:
  - name: environment
    displayName: 'Target Environment'
    type: string
    default: 'prod'
    values:
      - prod

variables:
  dotnetVersion: '7.x'
  azureSubscription: 'Azure-ServiceConnection' # Update with your service connection name
  keyVaultName: 'kv-personalwebsite-prod'
  connectionStringSecretName: 'SqlConnectionString'

stages:
  - stage: Migrate
    displayName: 'Apply Database Migrations'
    jobs:
      - deployment: MigrateDatabase
        displayName: 'Run EF Core Migrations'
        pool:
          vmImage: 'windows-latest'
        environment: 'database-${{ parameters.environment }}'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  fetchDepth: 1

                # Setup .NET
                - task: UseDotNet@2
                  displayName: 'Install .NET SDK'
                  inputs:
                    version: '$(dotnetVersion)'

                # Install EF Core tools
                - task: DotNetCoreCLI@2
                  displayName: 'Install EF Core Tools'
                  inputs:
                    command: 'custom'
                    custom: 'tool'
                    arguments: 'install --global dotnet-ef'

                # Get connection string from Key Vault
                - task: AzureKeyVault@2
                  displayName: 'Get Connection String from Key Vault'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    keyVaultName: '$(keyVaultName)'
                    secretsFilter: '$(connectionStringSecretName)'
                    runAsPreJob: false

                # Apply migrations
                - task: DotNetCoreCLI@2
                  displayName: 'Apply EF Core Migrations'
                  inputs:
                    command: 'custom'
                    custom: 'ef'
                    arguments: 'database update --project src/PersonalWebsite.Api/PersonalWebsite.Api.csproj --connection "$(SqlConnectionString)"'
                  env:
                    DOTNET_ENVIRONMENT: 'Production'

                # Verify migration
                - task: DotNetCoreCLI@2
                  displayName: 'List Applied Migrations'
                  inputs:
                    command: 'custom'
                    custom: 'ef'
                    arguments: 'migrations list --project src/PersonalWebsite.Api/PersonalWebsite.Api.csproj --connection "$(SqlConnectionString)"'
