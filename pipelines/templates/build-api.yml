# Template: Build .NET API
# Restores, builds, tests, and publishes the .NET API project

parameters:
  - name: workingDirectory
    type: string
    default: 'src/PersonalWebsite.Api'
  - name: buildConfiguration
    type: string
    default: 'Release'

steps:
  # Restore NuGet packages
  - task: DotNetCoreCLI@2
    displayName: 'Restore NuGet packages'
    inputs:
      command: 'restore'
      projects: '${{ parameters.workingDirectory }}/*.csproj'

  # Build
  - task: DotNetCoreCLI@2
    displayName: 'Build API'
    inputs:
      command: 'build'
      projects: '${{ parameters.workingDirectory }}/*.csproj'
      arguments: '--configuration ${{ parameters.buildConfiguration }} --no-restore'

  # Run tests (if test projects exist)
  - task: DotNetCoreCLI@2
    displayName: 'Run Unit Tests'
    inputs:
      command: 'test'
      projects: 'src/**/*Tests.csproj'
      arguments: '--configuration ${{ parameters.buildConfiguration }} --no-build --collect:"XPlat Code Coverage"'
    continueOnError: true

  # Publish
  - task: DotNetCoreCLI@2
    displayName: 'Publish API'
    inputs:
      command: 'publish'
      projects: '${{ parameters.workingDirectory }}/*.csproj'
      arguments: '--configuration ${{ parameters.buildConfiguration }} --no-build --output ${{ parameters.workingDirectory }}/bin/${{ parameters.buildConfiguration }}/net7.0/publish'
      publishWebProjects: false
