# =============================================================================
# Azure DevOps Pipeline - Infrastructure (Terraform)
# =============================================================================
# GitOps Workflow:
#   1. Create feature branch, make changes
#   2. Push branch ‚Üí PR to main
#   3. Pipeline runs: Security scans + Terraform plan (PR validation)
#   4. Review plan in PR, approve PR
#   5. Merge to main ‚Üí Terraform apply runs
#
# All deployments use the Azure DevOps service principal - never local applies!
# =============================================================================

# Only trigger on main branch (after PR merge)
trigger:
  branches:
    include:
      - main
  paths:
    include:
      - infra/**

# Run validation on PRs targeting main
pr:
  branches:
    include:
      - main
  paths:
    include:
      - infra/**

variables:
  terraformVersion: '1.5.0'
  azureSubscription: 'Azure-ServiceConnection'
  backendResourceGroup: 'rg-terraform-state'
  backendStorageAccount: 'stpaborwebsitetfstate'
  backendContainerName: 'tfstate'
  backendKey: 'personalwebsite.terraform.tfstate'
  keyVaultName: 'kv-personalwebsite-prod'
  # Non-sensitive variables (safe to commit)
  subscriptionId: '16e19706-c60e-4dcf-a24c-050487191622'
  projectName: 'personalwebsite'
  tfEnvironment: 'prod'
  location: 'East US'

stages:
  # ==========================================================================
  # Stage 1: Security Scanning
  # ==========================================================================
  - stage: SecurityScan
    displayName: 'üîí Security Scanning'
    jobs:
      - job: SecretScanning
        displayName: 'üîç Secret & Security Scans'
        pool:
          name: 'Default'
        
        steps:
          - checkout: self
            fetchDepth: 0
            displayName: 'üì• Checkout Code'

          # -------------------------------------------------------------------
          # GitLeaks - Detect secrets in code
          # -------------------------------------------------------------------
          - script: |
              echo "##[section]Installing GitLeaks..."
              wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz
              tar -xzf gitleaks_8.18.0_linux_x64.tar.gz
              chmod +x gitleaks
              
              echo "##[section]Running GitLeaks scan..."
              ./gitleaks detect --source . --verbose --redact --exit-code 1 || {
                echo "##[error]‚ùå SECRETS DETECTED IN CODE! Review the output above."
                exit 1
              }
              echo "##[section]‚úÖ No secrets detected in code"
            displayName: 'üîç GitLeaks - Secret Scanning'
            continueOnError: false

          # -------------------------------------------------------------------
          # tfsec - Terraform security scanning
          # -------------------------------------------------------------------
          - script: |
              echo "##[section]Installing tfsec..."
              wget -q https://github.com/aquasecurity/tfsec/releases/download/v1.28.4/tfsec-linux-amd64
              chmod +x tfsec-linux-amd64
              
              echo "##[section]Running tfsec scan on Terraform code..."
              ./tfsec-linux-amd64 infra --format lovely --exclude-downloaded-modules || true
              
              echo ""
              echo "##[section]tfsec scan complete - review any warnings above"
            displayName: 'üõ°Ô∏è tfsec - Terraform Security'
            continueOnError: true

          # -------------------------------------------------------------------
          # Checkov - IaC compliance scanning
          # -------------------------------------------------------------------
          - script: |
              echo "##[section]Installing Checkov..."
              pip install checkov -q
              
              echo "##[section]Running Checkov compliance scan..."
              checkov -d infra --framework terraform --output cli --compact --soft-fail
              
              echo ""
              echo "##[section]Checkov scan complete - review any findings above"
            displayName: '‚úÖ Checkov - IaC Compliance'
            continueOnError: true

  # ==========================================================================
  # Stage 2: Terraform Plan
  # ==========================================================================
  - stage: Plan
    displayName: 'üìã Terraform Plan'
    dependsOn: SecurityScan
    condition: succeeded()
    jobs:
      - job: TerraformPlan
        displayName: 'üìù Plan Infrastructure Changes'
        pool:
          name: 'Default'
        
        steps:
          - checkout: self
            fetchDepth: 1
            displayName: 'üì• Checkout Code'

          # Get secrets from Key Vault
          - task: AzureKeyVault@2
            displayName: 'üîë Get Secrets from Key Vault'
            inputs:
              azureSubscription: '$(azureSubscription)'
              keyVaultName: '$(keyVaultName)'
              secretsFilter: 'SqlAdminUsername,SqlAdminPassword'
              runAsPreJob: false

          # Install Terraform
          - task: TerraformInstaller@1
            displayName: '‚öôÔ∏è Install Terraform $(terraformVersion)'
            inputs:
              terraformVersion: '$(terraformVersion)'

          # Terraform Init
          - task: TerraformTaskV4@4
            displayName: 'üîß Terraform Init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: 'infra'
              backendServiceArm: '$(azureSubscription)'
              backendAzureRmResourceGroupName: '$(backendResourceGroup)'
              backendAzureRmStorageAccountName: '$(backendStorageAccount)'
              backendAzureRmContainerName: '$(backendContainerName)'
              backendAzureRmKey: '$(backendKey)'

          # Terraform Validate
          - task: TerraformTaskV4@4
            displayName: '‚úîÔ∏è Terraform Validate'
            inputs:
              provider: 'azurerm'
              command: 'validate'
              workingDirectory: 'infra'

          # Terraform Plan
          - task: TerraformTaskV4@4
            name: terraformPlan
            displayName: 'üìù Terraform Plan'
            inputs:
              provider: 'azurerm'
              command: 'plan'
              workingDirectory: 'infra'
              environmentServiceNameAzureRM: '$(azureSubscription)'
              commandOptions: '-out=tfplan -detailed-exitcode -var="subscription_id=$(subscriptionId)" -var="project_name=$(projectName)" -var="environment=$(tfEnvironment)" -var="location=$(location)" -var="sql_admin_username=$(SqlAdminUsername)" -var="sql_admin_password=$(SqlAdminPassword)"'

          # Generate human-readable plan
          - script: |
              cd infra
              terraform show -no-color tfplan > tfplan.txt
              
              echo "##[section]=============================================="
              echo "##[section]üìã TERRAFORM PLAN - INFRASTRUCTURE CHANGES"
              echo "##[section]=============================================="
              echo ""
              cat tfplan.txt
              echo ""
              echo "##[section]=============================================="
              
              # Count changes for summary
              ADDS=$(grep -c "will be created" tfplan.txt 2>/dev/null || echo "0")
              CHANGES=$(grep -c "will be updated" tfplan.txt 2>/dev/null || echo "0")
              DESTROYS=$(grep -c "will be destroyed" tfplan.txt 2>/dev/null || echo "0")
              
              echo ""
              echo "##[section]üìä CHANGE SUMMARY"
              echo "##[section]=============================================="
              echo "  ‚ûï Resources to CREATE:  $ADDS"
              echo "  üîÑ Resources to UPDATE:  $CHANGES"  
              echo "  ‚ùå Resources to DESTROY: $DESTROYS"
              echo "##[section]=============================================="
              echo ""
              
              # Create summary file for artifact
              echo "TERRAFORM PLAN SUMMARY" > tfplan-summary.txt
              echo "======================" >> tfplan-summary.txt
              echo "Generated: $(date)" >> tfplan-summary.txt
              echo "" >> tfplan-summary.txt
              echo "Resources to CREATE:  $ADDS" >> tfplan-summary.txt
              echo "Resources to UPDATE:  $CHANGES" >> tfplan-summary.txt
              echo "Resources to DESTROY: $DESTROYS" >> tfplan-summary.txt
              echo "" >> tfplan-summary.txt
              echo "Review the full plan in tfplan.txt artifact" >> tfplan-summary.txt
            displayName: 'üìä Generate Plan Summary'

          # Publish plan binary (for apply stage)
          - task: PublishBuildArtifacts@1
            displayName: 'üì¶ Publish Plan (Binary)'
            inputs:
              pathToPublish: 'infra/tfplan'
              artifactName: 'terraform-plan'

          # Publish readable plan (for review)
          - task: PublishBuildArtifacts@1
            displayName: 'üìÑ Publish Plan (Readable)'
            inputs:
              pathToPublish: 'infra/tfplan.txt'
              artifactName: 'terraform-plan-readable'

          # Publish summary
          - task: PublishBuildArtifacts@1
            displayName: 'üìã Publish Plan Summary'
            inputs:
              pathToPublish: 'infra/tfplan-summary.txt'
              artifactName: 'terraform-plan-summary'

  # ==========================================================================
  # Stage 3: Terraform Apply (Only runs on main branch after PR merge)
  # ==========================================================================
  - stage: Apply
    displayName: 'üöÄ Terraform Apply'
    dependsOn: Plan
    # Only run Apply stage when:
    # 1. Plan succeeded AND
    # 2. This is the main branch (not a PR) AND
    # 3. Not a PR validation build
    condition: |
      and(
        succeeded(),
        eq(variables['Build.SourceBranch'], 'refs/heads/main'),
        ne(variables['Build.Reason'], 'PullRequest')
      )
    jobs:
      - deployment: TerraformApply
        displayName: 'üöÄ Apply Infrastructure Changes'
        pool:
          name: 'Default'
        # ‚ö†Ô∏è This environment must have approval configured in Azure DevOps
        # Go to: Pipelines > Environments > infrastructure-prod > Approvals and checks
        environment: 'infrastructure-prod'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  fetchDepth: 1
                  displayName: 'üì• Checkout Code'

                # Get secrets from Key Vault
                - task: AzureKeyVault@2
                  displayName: 'üîë Get Secrets from Key Vault'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    keyVaultName: '$(keyVaultName)'
                    secretsFilter: 'SqlAdminUsername,SqlAdminPassword'
                    runAsPreJob: false

                # Download plan artifact
                - task: DownloadBuildArtifacts@1
                  displayName: 'üì• Download Terraform Plan'
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: 'terraform-plan'
                    downloadPath: '$(System.ArtifactsDirectory)'

                # Install Terraform
                - task: TerraformInstaller@1
                  displayName: '‚öôÔ∏è Install Terraform $(terraformVersion)'
                  inputs:
                    terraformVersion: '$(terraformVersion)'

                # Terraform Init
                - task: TerraformTaskV4@4
                  displayName: 'üîß Terraform Init'
                  inputs:
                    provider: 'azurerm'
                    command: 'init'
                    workingDirectory: 'infra'
                    backendServiceArm: '$(azureSubscription)'
                    backendAzureRmResourceGroupName: '$(backendResourceGroup)'
                    backendAzureRmStorageAccountName: '$(backendStorageAccount)'
                    backendAzureRmContainerName: '$(backendContainerName)'
                    backendAzureRmKey: '$(backendKey)'

                # Terraform Apply
                - task: TerraformTaskV4@4
                  displayName: 'üöÄ Terraform Apply'
                  inputs:
                    provider: 'azurerm'
                    command: 'apply'
                    workingDirectory: 'infra'
                    environmentServiceNameAzureRM: '$(azureSubscription)'
                    commandOptions: '$(System.ArtifactsDirectory)/terraform-plan/tfplan'

                # Show outputs
                - script: |
                    cd infra
                    echo "##[section]=============================================="
                    echo "##[section]üì§ TERRAFORM OUTPUTS"
                    echo "##[section]=============================================="
                    terraform output
                    echo "##[section]=============================================="
                    echo ""
                    echo "##[section]‚úÖ Infrastructure deployment complete!"
                  displayName: 'üì§ Show Deployment Outputs'
